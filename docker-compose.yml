services:
  # Main application
  daimoniac/suppline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: daimoniac/suppline
    ports:
      - "8080:8080"  # API
      - "9090:9090"  # Metrics
      - "8081:8081"  # Health
    environment:
      - SUPPLINE_CONFIG=/config/daimoniac/suppline.yml
      - LOG_LEVEL=info
      - METRICS_PORT=9090
      - HEALTH_PORT=8081
      - API_PORT=8080
      - API_ENABLED=true
      - API_READ_ONLY=false
      - QUEUE_BUFFER_SIZE=1000
      - WORKER_POLL_INTERVAL=5m
      - WORKER_RETRY_ATTEMPTS=3
      - WORKER_RETRY_BACKOFF=10s
      - TRIVY_SERVER_ADDR=trivy:4954
      - SCANNER_TIMEOUT=5m
      - STATE_STORE_TYPE=sqlite
      - SQLITE_PATH=/data/daimoniac/suppline.db
      - RESCAN_INTERVAL=24h
      - ATTESTATION_KEY_PATH=/keys/cosign.key
      - ATTESTATION_KEY_PASSWORD=${ATTESTATION_KEY_PASSWORD}
    volumes:
      - ./data:/data
      - ./daimoniac/suppline.yml:/config/daimoniac/suppline.yml:ro
      - ./keys:/keys:ro
    depends_on:
      - trivy
    networks:
      - daimoniac/suppline
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Web UI
  ui:
    image: nginx:alpine
    container_name: daimoniac/suppline-ui
    ports:
      - "3000:80"
    environment:
      - API_BASE_URL=http://localhost:8080
    volumes:
      - ./ui:/usr/share/nginx/html-source:ro
      - ./ui/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ui-html:/usr/share/nginx/html
    entrypoint:
      - sh
      - -c
      - |
        cp -r /usr/share/nginx/html-source/* /usr/share/nginx/html/
        echo "window.APP_CONFIG = {\"apiBaseURL\": \"$$API_BASE_URL\"};" > /usr/share/nginx/html/config.js
        exec nginx -g 'daemon off;'
    depends_on:
      - daimoniac/suppline
    networks:
      - daimoniac/suppline
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # Trivy server
  trivy:
    image: aquasec/trivy:0.58.2
    container_name: trivy-server
    command: ["server", "--listen", "0.0.0.0:4954"]
    ports:
      - "4954:4954"
    environment:
      - TRIVY_CACHE_DIR=/trivy-cache
    volumes:
      - trivy-cache:/trivy-cache
    networks:
      - daimoniac/suppline
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4954/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  daimoniac/suppline:
    driver: bridge

volumes:
  trivy-cache:
    driver: local
  ui-html:
    driver: local
