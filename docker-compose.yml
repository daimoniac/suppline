services:
  # Main application
  suppline:
    image: daimoniac/suppline
    build:
      context: .
      dockerfile: Dockerfile
    container_name: suppline
    ports:
      - "8080:8080"  # API
      - "9090:9090"  # Metrics
      - "8081:8081"  # Health
    # Note: DOCKER_USERNAME and DOCKER_PASSWORD are used for Go template expansion
    # in suppline.yml credentials. Make sure to set these in your .env file.
    environment:
      - SUPPLINE_CONFIG=/config/suppline.yml
      - LOG_LEVEL=info
      - METRICS_PORT=9090
      - HEALTH_PORT=8081
      - API_PORT=8080
      - API_ENABLED=true
      - API_READ_ONLY=false
      - QUEUE_BUFFER_SIZE=1000
      - WORKER_POLL_INTERVAL=5m
      - WORKER_RETRY_ATTEMPTS=3
      - WORKER_RETRY_BACKOFF=10s
      - TRIVY_SERVER_ADDR=trivy:4954
      - SCANNER_TIMEOUT=5m
      - STATE_STORE_TYPE=sqlite
      - SQLITE_PATH=/data/suppline.db
      - RESCAN_INTERVAL=24h
      - SUPPLINE_API_KEY=${SUPPLINE_API_KEY}
      - ATTESTATION_KEY=${ATTESTATION_KEY}
      - ATTESTATION_KEY_PASSWORD=${ATTESTATION_KEY_PASSWORD}
      - DOCKER_USERNAME=${DOCKER_USERNAME}
      - DOCKER_PASSWORD=${DOCKER_PASSWORD}
    volumes:
      - ./data:/data
      - ./suppline.yml:/config/suppline.yml:ro
    depends_on:
      - trivy
    networks:
      - suppline
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Web UI
  ui:
    image: daimoniac/suppline-ui
    build:
      context: ui
      dockerfile: Dockerfile
    container_name: suppline-ui
    ports:
      - "3000:80"
    environment:
      - API_BASE_URL=http://localhost:3000
    depends_on:
      - suppline
    networks:
      - suppline
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # Trivy server
  trivy:
    image: aquasec/trivy:0.58.2
    container_name: trivy-server
    command: ["server", "--listen", "0.0.0.0:4954"]
    ports:
      - "4954:4954"
    environment:
      - TRIVY_CACHE_DIR=/trivy-cache
    volumes:
      - trivy-cache:/trivy-cache
    networks:
      - suppline
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4954/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Regsync - Registry synchronization
  regsync:
    image: daimoniac/regsync:latest
    container_name: regsync
    command: ["server", "-c", "/config/suppline.yml"]
    environment:
      - DOCKER_USERNAME=${DOCKER_USERNAME}
      - DOCKER_PASSWORD=${DOCKER_PASSWORD}
    volumes:
      - ./suppline.yml:/config/suppline.yml:ro
    networks:
      - suppline
    restart: unless-stopped

networks:
  suppline:
    driver: bridge

volumes:
  trivy-cache:
    driver: local
  ui-html:
    driver: local
