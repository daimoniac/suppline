# Default values for suppline
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Backend configuration
backend:
  replicaCount: 1

  # Secrets - these can be set via values-secrets.yaml or environment variables
  # DO NOT commit actual secrets to git
  secrets: {}

  image:
    repository: daimoniac/suppline
    pullPolicy: Always
    tag: "latest"

  service:
    type: ClusterIP
    port: 8080
    metricsPort: 9090
    healthPort: 8081

  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

  livenessProbe:
    httpGet:
      path: /health
      port: health
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /health
      port: health
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  env:
    LOG_LEVEL: "debug"
    API_ENABLED: "true"
    API_READ_ONLY: "false"
    QUEUE_BUFFER_SIZE: "1000"
    WORKER_POLL_RETRIEVAL: "5m"
    WORKER_RETRY_ATTEMPTS: "3"
    WORKER_RETRY_BACKOFF: "10s"
    SCANNER_TIMEOUT: "5m"
    RESCAN_INTERVAL: "24h"

  attestationKey:
    enabled: true

# Trivy sidecar configuration
trivy:
  image:
    repository: aquasec/trivy
    tag: "0.58.2"
    pullPolicy: IfNotPresent

  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

  livenessProbe:
    tcpSocket:
      port: 4954
    initialDelaySeconds: 30
    periodSeconds: 30

  readinessProbe:
    tcpSocket:
      port: 4954
    initialDelaySeconds: 10
    periodSeconds: 10

# Regsync configuration (optional)
regsync:
  enabled: true
  replicaCount: 1

  image:
    repository: daimoniac/regsync
    tag: "latest"
    pullPolicy: Always

  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

# Frontend (UI) configuration
frontend:
  enabled: true
  replicaCount: 1

  image:
    repository: daimoniac/suppline-ui
    tag: "latest"
    pullPolicy: Always

  service:
    type: ClusterIP
    port: 80

  resources:
    requests:
      memory: "32Mi"
      cpu: "50m"
    limits:
      memory: "64Mi"
      cpu: "100m"

  securityContext:
    runAsNonRoot: true
    runAsUser: 101  # nginx user
    runAsGroup: 101
    fsGroup: 101
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

  livenessProbe:
    httpGet:
      path: /
      port: http
    initialDelaySeconds: 10
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /
      port: http
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 3
    failureThreshold: 3

  # API base URL for the frontend to connect to backend
  apiBaseURL: "/api"

  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - host: suppline.development.socialhub.dev
        paths:
          - path: /
            pathType: Prefix
    tls:
      - hosts:
        - suppline.development.socialhub.dev
        secretName: suppline-oauth2-proxy

# Persistence configuration
persistence:
  # Data volume for SQLite database
  # Note: The PVC will be retained after helm uninstall to preserve data
  # If reinstalling, the existing PVC will be reused automatically
  data:
    enabled: true
    storageClassName: ""
    accessMode: ReadWriteOnce
    size: 10Gi
    annotations: {}

  # Trivy cache volume
  trivyCache:
    enabled: false
    storageClassName: ""
    accessMode: ReadWrite
    size: 5Gi
    annotations: {}

# ServiceAccount configuration
serviceAccount:
  create: true
  annotations: {}
  name: "suppline"

# RBAC configuration
rbac:
  create: true

# Pod annotations
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"
  prometheus.io/path: "/metrics"

# Image pull secrets
imagePullSecrets: []

# Private Docker Registry
# Deploys a self-contained Docker registry for storing scanned images..
# the helm chart will auto-generate credentials for accessing the registry.
# if you bring your own registry,
# you can disable this and provide registry credentials via values-secrets.yaml
# and set the SUPPLINE_REGISTRY_* secrets accordingly.
# these are then available in suppline.yml via {{ env}}
registry:
  enabled: true
  
  # Image configuration
  image:
    repository: registry
    tag: 2.8.3
    pullPolicy: IfNotPresent
  
  # Service configuration
  service:
    type: ClusterIP
    port: 5000
  
  # Persistence for registry data
  persistence:
    enabled: true
    accessMode: ReadWriteOnce
    size: 10Gi
    storageClass: ""
  
  # Registry credentials
  # If not provided, username defaults to "suppline" and password is auto-generated
  # credentials:
  #   username: ""  # Leave empty for default "suppline"
  #   password: ""  # Leave empty for auto-generated password
  
  # Registry secrets
  # htpasswd will be automatically generated from credentials
  # secrets:
  #   haSharedSecret: ""  # Optional: shared secret for registry security
  
  # Resources
  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  
  # Security context
  securityContext:
    enabled: true
    runAsUser: 1000
    fsGroup: 1000

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity: {}
