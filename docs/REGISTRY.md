# Private Docker Registry Setup

The Suppline Helm chart can optionally deploy a self-contained Docker registry for storing scanned images.

## Enabling the Registry

Set `registry.enabled: true` in your values file:

```yaml
registry:
  enabled: true
```

## Authentication Setup

The registry uses basic authentication with credentials automatically generated from `backend.secrets`:

**Set credentials in `values-secrets.yaml`:**

```yaml
backend:
  secrets:
    SUPPLINE_REGISTRY_USERNAME: "suppline"
    SUPPLINE_REGISTRY_PASSWORD: "your-secure-password"
```

That's it! An init container will automatically generate the htpasswd file from these credentials when the registry pod starts.

## Storage Configuration

The registry uses a 10GB PersistentVolumeClaim by default:

```yaml
registry:
  persistence:
    enabled: true
    size: 10Gi
    storageClass: ""  # Uses default storage class
```

## Integration with Suppline

When the registry is enabled, Suppline and Regsync are automatically configured to authenticate with it. The registry will be accessible at:

- **Internal URL:** `http://<release-name>-docker-registry:5000`
- **External access:** Not exposed by default (ClusterIP service)

## Complete Example

```yaml
# values-secrets.yaml
backend:
  secrets:
    SUPPLINE_REGISTRY_USERNAME: "suppline"
    SUPPLINE_REGISTRY_PASSWORD: "MySecureP@ssw0rd"
    # Other secrets...

registry:
  enabled: true
  persistence:
    enabled: true
    size: 10Gi
```

## Deploying

```bash
# Update dependencies to download the registry chart
helm dependency update charts/suppline

# Install with registry enabled
helm install suppline charts/suppline -f charts/suppline/values-secrets.yaml
```

## Verifying the Registry

```bash
# Check registry pod
kubectl get pods -l app=docker-registry

# Check PVC
kubectl get pvc

# Test authentication (from within cluster)
kubectl run -it --rm debug --image=curlimages/curl --restart=Never -- \
  curl -u suppline:MySecureP@ssw0rd http://suppline-docker-registry:5000/v2/_catalog
```

## Notes

- The registry chart dependency is managed in `Chart.yaml`
- htpasswd is automatically generated by an init container
- The registry uses bcrypt encryption for password security
- Registry data persists across pod restarts via PVC
- No manual htpasswd generation required!
