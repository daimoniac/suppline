services:
  # Trivy server for vulnerability scanning
  trivy-server:
    image: aquasec/trivy:latest
    container_name: trivy-server
    command: server --listen 0.0.0.0:4954 --skip-db-update
    ports:
      - "4954:4954"
    volumes:
      - trivy-cache:/root/.cache/trivy
    environment:
      # Skip Java DB download for faster startup in CI
      TRIVY_SKIP_JAVA_DB_UPDATE: "true"
    healthcheck:
      test: ["CMD", "trivy", "version"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Local Docker registry for testing
  test-registry:
    image: registry:2
    container_name: test-registry
    ports:
      - "5000:5000"
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5000/v2/"]
      interval: 5s
      timeout: 3s
      retries: 3

  # SQLite doesn't need a separate container, but we'll use a volume for persistence
  # The application will connect to the local SQLite file

volumes:
  trivy-cache:
    driver: local
